using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using System.Globalization;

namespace PSLogging {
    public class RotatableLogfile : Logfile {

        private FileInfo fileInfo = null;
        private int maxsize;

        public RotatableLogfile(string path, int maxsize)
            : base(path) {
            this.fileInfo = new FileInfo(path);
            this.maxsize = maxsize;
            this.MaxCount = 0;
        }

        public int MaxCount { get; set; }

        public override void Write(string message) {
            this.rotateIfNeeded(message);
            base.Write(message);
        }

        private void rotateIfNeeded(string message) {
            lock(this.syncObject) {
                if((fileInfo.Length + message.Length) < this.maxsize) {
                    return;
                }
                String rotateFile = this.Path + ".rot";
                String newFile = this.Path + ".1";

                File.Move(this.Path, rotateFile);
                moveFilesIfNeeded();
                File.Move(rotateFile, newFile);
                this.textWriter = TextWriter.Synchronized(File.AppendText(this.path));
            }
        }

        private void moveFilesIfNeeded() {
            if(this.MaxCount == 0) {
                return;
            }

            int i = 0;
            while(File.Exists(this.Path + "." + i.ToString()) && i <= this.MaxCount) {
                i++;
            }

            if(File.Exists(this.Path + "." + i.ToString())) {
                if(i == this.MaxCount) {
                    //delete the oldest file
                    File.Delete(this.Path + "." + this.MaxCount);
                    i--;
                }

                while(i >= 1) {
                    string sourcePath = this.Path + "." + i.ToString();
                    string destinationPath = this.Path + "." + (i + 1).ToString();
                    File.Move(sourcePath, destinationPath);
                    i--;
                }
            }
        }
    }
}
